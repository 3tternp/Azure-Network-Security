{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Azure App GW WAF Monitor Workbook - Resource Specific Logs",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "workbook",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The resource id of the Log Analytics Workspace resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2022-04-01",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Azure WAF Monitor Workbook\\r\\n---\"},\"name\":\"Workbook Title\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"9a5fb8f4-61fa-4a63-bc89-ade6a64187a9\",\"cellValue\":\"SelectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Azure WAF Logs\",\"subTarget\":\"WAFLogs\",\"style\":\"link\"},{\"id\":\"b3e39e6e-e8ba-418d-a632-63b5903fd594\",\"cellValue\":\"SelectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Azure WAF Metrics - Application Gateway\",\"subTarget\":\"WAFMetricsAppGW\",\"style\":\"link\"}]},\"name\":\"Workbook Tabs\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"e1c085f6-3a26-435e-adc0-093bbf6e41e0\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"summarize by subscriptionId\\r\\n| project value=strcat(\\\"/subscriptions/\\\", subscriptionId), label = subscriptionId\",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":[\"/subscriptions/1c61ccbf-70b3-45a3-a1fb-848ce46d70a6\"]},{\"id\":\"all\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspaces\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| project id\",\"crossComponentResources\":[\"value::selected\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":[\"/all\"]},{\"id\":\"c723f64f-b97e-4add-9e1d-e6b4eddf6719\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":2419200000}},{\"id\":\"2d68e64a-c15e-4449-adb8-7c0ed052b739\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"WAFType\",\"label\":\"WAF Type\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\\"Application Gateway\\\"]\",\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"value\":\"Application Gateway\"},{\"id\":\"86f806a3-1663-405b-8e33-8ddab4e0d563\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"WAF\",\"label\":\"WAF Items\",\"type\":5,\"isRequired\":true,\"query\":\"Resources\\r\\n| where type =~ 'Microsoft.Network/ApplicationGateways'| project id, name\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":\"/all\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"Workbook Parameters\"},{\"type\":1,\"content\":{\"json\":\"### Azure WAF Metrics\\r\\nThe data below dosen't read from the Log Analytics workpsace, it's reading directly from the resources which requires resource visibility. The following metrics have 'SplitBy' dimensions set that will not run properly when multiple resources are selected. \\r\\nClick [here for more information on Azure Metrics](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/data-platform-metrics)\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isNotEqualTo\",\"value\":\"WAFLogs\"},\"name\":\"WAF Metric Warning\"},{\"type\":10,\"content\":{\"chartId\":\"workbookc21108a5-6fd3-403e-aafd-d8b6eb53bae8\",\"version\":\"MetricsItem/2.0\",\"size\":0,\"chartType\":2,\"resourceType\":\"microsoft.network/applicationgateways\",\"metricScope\":0,\"resourceParameter\":\"WAF\",\"resourceIds\":[\"{WAF}\"],\"timeContextFromParameter\":\"TimeRange\",\"timeContext\":{\"durationMs\":2419200000},\"metrics\":[{\"namespace\":\"microsoft.network/applicationgateways\",\"metric\":\"microsoft.network/applicationgateways--AzwafTotalRequests\",\"aggregation\":1,\"splitBy\":[\"PolicyName\"]}],\"title\":\"WAF Total Requests - Application Gateway\",\"gridSettings\":{\"rowLimit\":10000}},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"WAFMetricsAppGW\"},\"name\":\"WAF Total Requests - Application Gateway\"},{\"type\":10,\"content\":{\"chartId\":\"workbook52eb8d72-7af5-4c4f-8e72-434507e3a051\",\"version\":\"MetricsItem/2.0\",\"size\":0,\"chartType\":2,\"resourceType\":\"microsoft.network/applicationgateways\",\"metricScope\":0,\"resourceParameter\":\"WAF\",\"resourceIds\":[\"{WAF}\"],\"timeContextFromParameter\":\"TimeRange\",\"timeContext\":{\"durationMs\":2419200000},\"metrics\":[{\"namespace\":\"microsoft.network/applicationgateways\",\"metric\":\"microsoft.network/applicationgateways--AzwafSecRule\",\"aggregation\":1,\"splitBy\":[\"RuleGroupID\"]}],\"title\":\"WAF Managed Rule Blocks by RuleGroup - Application Gateway\",\"filters\":[{\"id\":\"1\",\"key\":\"Action\",\"operator\":0,\"values\":[\"Block\"]}],\"gridSettings\":{\"rowLimit\":10000}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"WAFMetricsAppGW\"},\"name\":\"WAF Managed Rule Matches - RuleGroup - Block - Application Gateway\"},{\"type\":10,\"content\":{\"chartId\":\"workbook52eb8d72-7af5-4c4f-8e72-434507e3a051\",\"version\":\"MetricsItem/2.0\",\"size\":0,\"chartType\":2,\"resourceType\":\"microsoft.network/applicationgateways\",\"metricScope\":0,\"resourceParameter\":\"WAF\",\"resourceIds\":[\"{WAF}\"],\"timeContextFromParameter\":\"TimeRange\",\"timeContext\":{\"durationMs\":2419200000},\"metrics\":[{\"namespace\":\"microsoft.network/applicationgateways\",\"metric\":\"microsoft.network/applicationgateways--AzwafSecRule\",\"aggregation\":1,\"splitBy\":[\"RuleGroupID\"]}],\"title\":\"WAF Managed Rule Allows by RuleGroup - Application Gateway\",\"filters\":[{\"id\":\"1\",\"key\":\"Action\",\"operator\":0,\"values\":[\"Pass\"]}],\"gridSettings\":{\"rowLimit\":10000}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"WAFMetricsAppGW\"},\"name\":\"WAF Managed Rule Matches - RuleGroup - Allow - Application Gateway\"},{\"type\":10,\"content\":{\"chartId\":\"workbook52eb8d72-7af5-4c4f-8e72-434507e3a051\",\"version\":\"MetricsItem/2.0\",\"size\":0,\"chartType\":2,\"resourceType\":\"microsoft.network/applicationgateways\",\"metricScope\":0,\"resourceParameter\":\"WAF\",\"resourceIds\":[\"{WAF}\"],\"timeContextFromParameter\":\"TimeRange\",\"timeContext\":{\"durationMs\":2419200000},\"metrics\":[{\"namespace\":\"microsoft.network/applicationgateways\",\"metric\":\"microsoft.network/applicationgateways--AzwafSecRule\",\"aggregation\":1,\"splitBy\":[\"RuleID\"]}],\"title\":\"WAF Managed Rule Blocks by RuleId - Application Gateway\",\"filters\":[{\"id\":\"1\",\"key\":\"Action\",\"operator\":0,\"values\":[\"Block\"]}],\"gridSettings\":{\"rowLimit\":10000}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"WAFMetricsAppGW\"},\"name\":\"WAF Managed Rule Matches - RuleId - Block - Application Gateway\"},{\"type\":10,\"content\":{\"chartId\":\"workbook52eb8d72-7af5-4c4f-8e72-434507e3a051\",\"version\":\"MetricsItem/2.0\",\"size\":0,\"chartType\":2,\"resourceType\":\"microsoft.network/applicationgateways\",\"metricScope\":0,\"resourceParameter\":\"WAF\",\"resourceIds\":[\"{WAF}\"],\"timeContextFromParameter\":\"TimeRange\",\"timeContext\":{\"durationMs\":2419200000},\"metrics\":[{\"namespace\":\"microsoft.network/applicationgateways\",\"metric\":\"microsoft.network/applicationgateways--AzwafSecRule\",\"aggregation\":1,\"splitBy\":[\"RuleID\"]}],\"title\":\"WAF Managed Rule Allows by RuleId - Application Gateway\",\"filters\":[{\"id\":\"1\",\"key\":\"Action\",\"operator\":0,\"values\":[\"Pass\"]}],\"gridSettings\":{\"rowLimit\":10000}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"WAFMetricsAppGW\"},\"name\":\"WAF Managed Rule Matches - RuleId - Allow - Application Gateway\"},{\"type\":10,\"content\":{\"chartId\":\"workbook52eb8d72-7af5-4c4f-8e72-434507e3a051\",\"version\":\"MetricsItem/2.0\",\"size\":0,\"chartType\":2,\"resourceType\":\"microsoft.network/applicationgateways\",\"metricScope\":0,\"resourceParameter\":\"WAF\",\"resourceIds\":[\"{WAF}\"],\"timeContextFromParameter\":\"TimeRange\",\"timeContext\":{\"durationMs\":2419200000},\"metrics\":[{\"namespace\":\"microsoft.network/applicationgateways\",\"metric\":\"microsoft.network/applicationgateways--AzwafSecRule\",\"aggregation\":1,\"splitBy\":[\"CountryCode\"]}],\"title\":\"WAF Managed Rule Blocks by GeoLocation - Application Gateway\",\"filters\":[{\"id\":\"1\",\"key\":\"Action\",\"operator\":0,\"values\":[\"Block\"]}],\"gridSettings\":{\"rowLimit\":10000}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"WAFMetricsAppGW\"},\"name\":\"WAF Managed Rule Matches - GeoLocation - Block - Application Gateway\"},{\"type\":10,\"content\":{\"chartId\":\"workbook52eb8d72-7af5-4c4f-8e72-434507e3a051\",\"version\":\"MetricsItem/2.0\",\"size\":0,\"chartType\":2,\"resourceType\":\"microsoft.network/applicationgateways\",\"metricScope\":0,\"resourceParameter\":\"WAF\",\"resourceIds\":[\"{WAF}\"],\"timeContextFromParameter\":\"TimeRange\",\"timeContext\":{\"durationMs\":2419200000},\"metrics\":[{\"namespace\":\"microsoft.network/applicationgateways\",\"metric\":\"microsoft.network/applicationgateways--AzwafSecRule\",\"aggregation\":1,\"splitBy\":[\"CountryCode\"]}],\"title\":\"WAF Managed Rule Allows by GeoLocation - Application Gateway\",\"filters\":[{\"id\":\"1\",\"key\":\"Action\",\"operator\":0,\"values\":[\"Pass\"]}],\"gridSettings\":{\"rowLimit\":10000}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"WAFMetricsAppGW\"},\"name\":\"WAF Managed Rule Matches - GeoLocation - Allow - Application Gateway\"},{\"type\":10,\"content\":{\"chartId\":\"workbook52eb8d72-7af5-4c4f-8e72-434507e3a051\",\"version\":\"MetricsItem/2.0\",\"size\":0,\"chartType\":2,\"resourceType\":\"microsoft.network/applicationgateways\",\"metricScope\":0,\"resourceParameter\":\"WAF\",\"resourceIds\":[\"{WAF}\"],\"timeContextFromParameter\":\"TimeRange\",\"timeContext\":{\"durationMs\":2419200000},\"metrics\":[{\"namespace\":\"microsoft.network/applicationgateways\",\"metric\":\"microsoft.network/applicationgateways--AzwafCustomRule\",\"aggregation\":1,\"splitBy\":[\"CustomRuleID\"]}],\"title\":\"WAF Custom Rules Matches by RuleName - ApplicationGateway\",\"filters\":[{\"id\":\"1\",\"key\":\"Action\",\"operator\":0,\"values\":[\"Block\",\"Pass\",\"JSChallenge\"]}],\"gridSettings\":{\"rowLimit\":10000}},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"WAFMetricsAppGW\"},\"name\":\"WAF Custom Rules Matches -RuleName - Block/Pass - ApplicationGateway\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AGWFirewallLogs\\r\\n| where _ResourceId in~ (split(\\\"{WAF}\\\", \\\",\\\"))\\r\\n| extend Rule = Message\\r\\n| extend Action = iif(Action == \\\"Blocked\\\", \\\"Block\\\", Action)\\r\\n| extend Action = iif(Action == \\\"Detected\\\", \\\"Log\\\", Action)\\r\\n| extend Action = iif(Action == \\\"JSChallenge\\\", \\\"JSChallenge\\\", Action)\\r\\n| summarize number = count() by Action\",\"size\":3,\"showAnalytics\":true,\"title\":\"WAF actions filter\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"series\",\"exportParameterName\":\"SelectedAction\",\"exportDefaultValue\":\"*\",\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"visualization\":\"piechart\"},\"customWidth\":\"27\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"WAFLogs\"},\"name\":\"query - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let FakeData = (datatable (Message:string, ClientIp:string, Action:string, TransactionId:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\" ]);\\r\\nunion AGWFirewallLogs\\r\\n| where _ResourceId in~ (split(\\\"{WAF}\\\", \\\",\\\"))\\r\\n| extend Rule = Message\\r\\n| extend Action = iif(Action == \\\"Blocked\\\", \\\"Block\\\", Action)\\r\\n| extend Action = iif(Action == \\\"Detected\\\", \\\"Log\\\", Action)\\r\\n| extend Action = iif(Action == \\\"JSChallenge\\\", \\\"JSChallenge\\\", Action)\\r\\n| where Action == \\\"Block\\\"\\r\\n| where RequestUri <> \\\"/\\\"\\r\\n| summarize count() by RequestUri \\r\\n| top 40 by count_ desc \",\"size\":3,\"showAnalytics\":true,\"title\":\"Top 40 Blocked Request URI addresses, filter to single URI address\",\"noDataMessage\":\"The current data has no \\\"Blocked\\\" results\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"requestUri_s\",\"exportParameterName\":\"RequestURI\",\"exportDefaultValue\":\"*\",\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"RequestUri\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":8,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2,\"maximumSignificantDigits\":5}}},\"showBorder\":false},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"requestUri_s\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"mapSettings\":{\"locInfo\":\"LatLong\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"type\":\"heatmap\",\"colorAggregation\":\"Sum\",\"nodeColorField\":\"count_\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"63\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"WAFLogs\"},\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let FakeData = (datatable (Message:string, ClientIp:string, Action:string, TransactionId:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\" ]);\\r\\nunion AGWFirewallLogs\\r\\n| where _ResourceId in~ (split(\\\"{WAF}\\\", \\\",\\\"))\\r\\n| extend Action = case(\\r\\n    Action == \\\"Blocked\\\", \\\"Block\\\",\\r\\n    Action == \\\"Detected\\\", \\\"Log\\\",\\r\\n    Action\\r\\n)\\r\\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \\\"*\\\"\\r\\n| where '{RequestURI}' == RequestUri or '{RequestURI}' == \\\"*\\\"| extend Rule = Message\\r\\n| extend Rule= iif(Rule contains \\\"Mandatory rule. Cannot be disabled.\\\", strcat_array(split(Rule, \\\"Mandatory rule. Cannot be disabled. Inbound \\\",1),\\\"\\\"), Rule) // Removes initial component for mandatory rule \\r\\n| extend Rule = iif(Rule contains \\\"Total Inbound Score\\\", strcat_array(array_concat(split(Rule, \\\" - SQLI=\\\", 0), parse_json('[\\\") -\\\"]'), split(Rule,\\\"):\\\",1)),\\\"\\\"),Rule) // Removes smaller information if more info is available for anomaly score\\r\\n| summarize count() by Rule\\r\\n| top 50 by count_ desc\",\"size\":0,\"showAnalytics\":true,\"title\":\"Top 50 event trigger, filter by rule name\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Rule\",\"exportParameterName\":\"Selected\",\"exportDefaultValue\":\"*\",\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"count_\",\"formatter\":3,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true}}],\"sortBy\":[{\"itemKey\":\"$gen_bar_count__1\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"$gen_bar_count__1\",\"sortOrder\":2}]},\"customWidth\":\"30\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"WAFLogs\"},\"name\":\"query - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let FakeData = (datatable (Message:string, ClientIp:string, Action:string, TransactionId:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\" ]);\\r\\nunion AGWFirewallLogs\\r\\n| where _ResourceId in~ (split(\\\"{WAF}\\\", \\\",\\\"))\\r\\n| extend Action = case(\\r\\n    Action == \\\"Blocked\\\", \\\"Block\\\",\\r\\n    Action == \\\"Detected\\\", \\\"Log\\\",\\r\\n    Action\\r\\n)\\r\\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \\\"*\\\"\\r\\n| where '{RequestURI}' == RequestUri or '{RequestURI}' == \\\"*\\\"| extend Rule = Message\\r\\n| where '{Selected}' == Rule or '{Selected}' == \\\"*\\\"\\r\\n| summarize count() by Rule, bin(TimeGenerated, 1h)\",\"size\":0,\"showAnalytics\":true,\"title\":\"Messages, by time\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"visualization\":\"barchart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Message\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"70\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"WAFLogs\"},\"name\":\"query - 13\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let FakeData = (datatable (Message:string, ClientIp:string, Action:string, TransactionId:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\" ]);\\r\\nunion AGWFirewallLogs\\r\\n| where _ResourceId in~ (split(\\\"{WAF}\\\", \\\",\\\"))\\r\\n| extend Action = case(\\r\\n    Action == \\\"Blocked\\\", \\\"Block\\\",\\r\\n    Action == \\\"Detected\\\", \\\"Log\\\",\\r\\n    Action\\r\\n)\\r\\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \\\"*\\\"\\r\\n| where '{RequestURI}' == RequestUri or '{RequestURI}' == \\\"*\\\"| extend Rule = strcat(RuleId, \\\" \\\", \\\" \\\", RuleSetVersion)\\r\\n| where '{Selected}' == Rule or '{Selected}' == \\\"*\\\"\\r\\n| extend Role = extract(\\\"ApplicationGateway([a-zA-Z_a-zA-Z_0-9]*)\\\", 1, InstanceId)\\r\\n| extend RequestUri = RequestUri, RuleSetType = RuleSetType, Hostname = Hostname  \\r\\n| project \\r\\n    Rule,\\r\\n    TimeGenerated,\\r\\n    Hostname,\\r\\n    _ResourceId,\\r\\n    Role,\\r\\n    Action,\\r\\n    RequestUri,\\r\\n    RuleSetType,\\r\\n    ClientIP = ClientIp,\\r\\n    Message_Details = Message\\r\\n| sort by TimeGenerated desc\",\"size\":0,\"showAnalytics\":true,\"title\":\"Message, full details\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"visualization\":\"table\",\"gridSettings\":{\"filter\":true},\"sortBy\":[]},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"WAFLogs\"},\"name\":\"query - 11\"},{\"type\":1,\"content\":{\"json\":\"---\"},\"name\":\"text - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let FakeData = (datatable (Message:string, ClientIp:string, Action:string, TransactionId:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\" ]);\\r\\nunion AGWFirewallLogs\\r\\n| where _ResourceId in~ (split(\\\"{WAF}\\\", \\\",\\\"))\\r\\n| where '{RequestURI}' == RequestUri or '{RequestURI}' == \\\"*\\\"\\r\\n| where Message contains \\\"attack\\\"\\r\\n| extend Rule = Message\\r\\n| extend Action = case(\\r\\n    Action == \\\"Blocked\\\", \\\"Block\\\",\\r\\n    Action == \\\"Detected\\\", \\\"Log\\\",\\r\\n    Action\\r\\n)\\r\\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \\\"*\\\"\\r\\n| summarize Amount = count() by Rule\\r\\n| order by Amount desc\",\"size\":0,\"title\":\"Attacks events, by messages and filterable by rule name\",\"noDataMessage\":\"Filtered messages are not attack events\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"\",\"exportParameterName\":\"MessageFilter\",\"exportDefaultValue\":\"{\\\"Rule\\\":\\\"*\\\"}\",\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Amount\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueDark\",\"showIcon\":true,\"aggregation\":\"Sum\"}}],\"filter\":true},\"sortBy\":[]},\"customWidth\":\"20\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"WAFLogs\"},\"name\":\"query - 16\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedMS = dynamic({MessageFilter}); // reference to the above list of messages (Event trigger)\\r\\nlet Child = SelectedMS.Rule; // Used to choose a group of messages - redirects to the message which was grouped\\r\\nlet FakeData = (datatable (Message:string, ClientIp:string, Action:string, TransactionId:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\" ]);\\r\\nunion AGWFirewallLogs\\r\\n| where _ResourceId in~ (split(\\\"{WAF}\\\", \\\",\\\"))\\r\\n| where '{RequestURI}' == RequestUri or '{RequestURI}' == \\\"*\\\"\\r\\n| where Message contains \\\"attack\\\"\\r\\n| extend Rule = Message\\r\\n| extend Action = case(\\r\\n    Action == \\\"Blocked\\\", \\\"Block\\\",\\r\\n    Action == \\\"Detected\\\", \\\"Log\\\",\\r\\n    Action\\r\\n)\\r\\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \\\"*\\\"\\r\\n| where Rule == Child or Child == \\\"*\\\"\\r\\n| where '{Selected}' == Rule or '{Selected}' == \\\"*\\\"\\r\\n| summarize Amount = count() by Rule, bin(TimeGenerated, 1h), _ResourceId\\r\\n| project Amount, Rule, TimeGenerated, _ResourceId\\r\\n| order by Amount desc\",\"size\":0,\"showAnalytics\":true,\"title\":\"Attack events, by time\",\"noDataMessage\":\"Filtered messages are not attack events\",\"timeContextFromParameter\":\"TimeRange\",\"exportParameterName\":\"Message\",\"exportDefaultValue\":\"{ \\\"Name\\\":\\\"\\\", \\\"Type\\\":\\\"*\\\"}\",\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"visualization\":\"areachart\"},\"customWidth\":\"80\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"WAFLogs\"},\"name\":\"query - 14\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedMS = dynamic({MessageFilter}); // reference to the above list of messages (Event trigger)\\r\\nlet Child = SelectedMS.Rule; // Used to choose a group of messages - redirects to the message which was grouped\\r\\nlet FakeData = (datatable (Message:string, ClientIp:string, Action:string, TransactionId:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\" ]);\\r\\nunion AGWFirewallLogs\\r\\n| where _ResourceId in~ (split(\\\"{WAF}\\\", \\\",\\\"))\\r\\n| where '{RequestURI}' == RequestUri or '{RequestURI}' == \\\"*\\\"| extend Rule = Message\\r\\n| extend Action = case(\\r\\n    Action == \\\"Blocked\\\", \\\"Block\\\",\\r\\n    Action == \\\"Detected\\\", \\\"Log\\\",\\r\\n    Action\\r\\n)\\r\\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \\\"*\\\"\\r\\n| extend TrackingID = TransactionId\\r\\n| where '{Selected}' == Rule or '{Selected}' == \\\"*\\\"\\r\\n| where Rule == Child or Child == \\\"*\\\" \\r\\n| distinct TrackingID\",\"size\":0,\"showAnalytics\":true,\"title\":\"TrackingID filter\",\"noDataMessage\":\"You've over filtered or you're missing this data.\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"TrackingID\",\"exportParameterName\":\"SelectedTrackingID\",\"exportDefaultValue\":\"*\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"gridSettings\":{\"rowLimit\":500,\"filter\":true,\"sortBy\":[{\"itemKey\":\"TrackingID\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"TrackingID\",\"sortOrder\":2}]},\"customWidth\":\"20\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"WAFLogs\"},\"name\":\"query - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedMS = dynamic({MessageFilter}); \\r\\nlet Child = SelectedMS.Rule; \\r\\nlet FakeData = (datatable (Message:string, ClientIp:string, Action:string, TransactionId:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\" ]);\\r\\nunion AGWFirewallLogs\\r\\n| where _ResourceId in~ (split(\\\"{WAF}\\\", \\\",\\\"))\\r\\n| where '{RequestURI}' == RequestUri or '{RequestURI}' == \\\"*\\\"| extend Rule = strcat(RuleId, \\\" \\\", \\\" \\\", RuleSetVersion)\\r\\n| extend Action = case(\\r\\n    Action == \\\"Blocked\\\", \\\"Block\\\",\\r\\n    Action == \\\"Detected\\\", \\\"Log\\\",\\r\\n    Action\\r\\n)\\r\\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \\\"*\\\"\\r\\n| extend TrackingID = TransactionId\\r\\n| where '{SelectedTrackingID}' == TrackingID or '{SelectedTrackingID}' == \\\"*\\\" \\r\\n| where '{Selected}' == Rule or '{Selected}' == \\\"*\\\"\\r\\n| where Rule == Child or Child == \\\"*\\\"\\r\\n| extend \\r\\n    InstandUri = InstanceId,\\r\\n    RequestUri = RequestUri,\\r\\n    RuleSetType = RuleSetType,\\r\\n    Message_Details = Message,\\r\\n    Hostname = Hostname,\\r\\n    TrackingID = TransactionId\\r\\n| project \\r\\n    TrackingID,\\r\\n    TimeGenerated,\\r\\n    Rule,\\r\\n    ClientIP = ClientIp,\\r\\n    InstandUri,\\r\\n    RequestUri,\\r\\n    RuleSetType,\\r\\n    Action,\\r\\n    Message_Details,\\r\\n    Hostname\",\"size\":0,\"showAnalytics\":true,\"title\":\"TrackingID Messages\",\"noDataMessage\":\"You've over filtered or you're missing this data.\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"gridSettings\":{\"rowLimit\":50}},\"customWidth\":\"80\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"WAFLogs\"},\"name\":\"query - 13\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedMS = dynamic({MessageFilter}); \\r\\nlet Child = SelectedMS.Rule; \\r\\nlet FakeData = datatable (Message:string, ClientIp:string, Action:string, TransactionId:string) [ \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\" ];\\r\\nFakeData\\r\\n| union AGWFirewallLogs\\r\\n| where _ResourceId in~ (split(\\\"{WAF}\\\", \\\",\\\"))\\r\\n| where '{RequestURI}' == RequestUri or '{RequestURI}' == \\\"*\\\"\\r\\n| where Message contains \\\"attack\\\" \\r\\n| extend Rule = Message\\r\\n| extend Action = case(\\r\\n    Action == \\\"Blocked\\\", \\\"Block\\\",\\r\\n    Action == \\\"Detected\\\", \\\"Log\\\",\\r\\n    Action\\r\\n)\\r\\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \\\"*\\\"\\r\\n| extend TrackingID = TransactionId\\r\\n| where '{SelectedTrackingID}' == TrackingID or '{SelectedTrackingID}' == \\\"*\\\" \\r\\n| where Rule == Child or Child == \\\"*\\\"\\r\\n| where '{Selected}' == Rule or '{Selected}' == \\\"*\\\"\\r\\n| summarize Attacks = count() by ClientIp\\r\\n| top 10 by Attacks desc\\r\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"Top 10 Attacking IP Addresses, filter to single IP address\",\"noDataMessage\":\"Filtered messages are not attack events\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"x\",\"exportParameterName\":\"ClientIP\",\"exportDefaultValue\":\"*\",\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"visualization\":\"barchart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"ClientIP\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"ClientIP\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"showLegend\":true},\"mapSettings\":{\"locInfo\":\"LatLong\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"type\":\"heatmap\",\"colorAggregation\":\"Sum\",\"nodeColorField\":\"count_\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"25\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"WAFLogs\"},\"name\":\"query - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedMS = dynamic({MessageFilter}); \\r\\nlet Child = SelectedMS.Rule; \\r\\nlet FakeData = datatable (\\r\\n    Message:string,\\r\\n    ClientIp:string,\\r\\n    Action:string,\\r\\n    TransactionId:string,\\r\\n    InstanceId:string,\\r\\n    RequestUri:string,\\r\\n    RuleSetType:string,\\r\\n    RuleId:string,\\r\\n    Hostname:string\\r\\n) [\\r\\n    \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\", \\\"\\\"\\r\\n];\\r\\nunion AGWFirewallLogs\\r\\n| where _ResourceId in~ (split(\\\"{WAF}\\\", \\\",\\\"))\\r\\n| where '{RequestURI}' == RequestUri or '{RequestURI}' == \\\"*\\\"\\r\\n| where Message contains \\\"attack\\\"\\r\\n| extend Rule = Message\\r\\n| where Rule == Child or Child == \\\"*\\\"\\r\\n| extend Action = case(\\r\\n    Action == \\\"Blocked\\\", \\\"Block\\\",\\r\\n    Action == \\\"Detected\\\", \\\"Log\\\",\\r\\n    Action\\r\\n)\\r\\n| where '{SelectedAction}' == Action or '{SelectedAction}' == \\\"*\\\"\\r\\n| extend TrackingID = TransactionId\\r\\n| where '{SelectedTrackingID}' == TrackingID or '{SelectedTrackingID}' == \\\"*\\\" \\r\\n| where '{Selected}' == Rule or '{Selected}' == \\\"*\\\"\\r\\n| extend \\r\\n    InstandUri = InstanceId,\\r\\n    RequestUri = RequestUri,\\r\\n    RuleSetType = RuleSetType,\\r\\n    Message_Details = Message,\\r\\n    Hostname = Hostname,\\r\\n    RuleGroup = \\\"\\\",           \\r\\n    File_Details = \\\"\\\",        \\r\\n    Data_Details = \\\"\\\",        \\r\\n    Category = \\\"\\\"            \\r\\n| project \\r\\n    TimeGenerated,\\r\\n    Rule,\\r\\n    ClientIp,\\r\\n    RuleGroup,\\r\\n    InstandUri,\\r\\n    RequestUri,\\r\\n    RuleSetType,\\r\\n    Action,\\r\\n    Message_Details,\\r\\n    File_Details,\\r\\n    Data_Details,\\r\\n    Hostname,\\r\\n    Category\\r\\n\",\"size\":0,\"title\":\"Attack messages of IP address\",\"noDataMessage\":\"Filtered messages are not attack events\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"visualization\":\"table\",\"gridSettings\":{\"filter\":true}},\"customWidth\":\"75\",\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"WAFLogs\"},\"showPin\":true,\"name\":\"query - 13\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"/all\"],\"fromTemplateId\":\"sentinel-WebApplicationFirewallFirewallEvents\"}",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}